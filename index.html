<!DOCTYPE html>
<html>
<head>
  <script
    src="https://code.jquery.com/jquery-3.6.1.min.js"
    integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
    crossorigin="anonymous"></script>
  <script language="javascript" type="text/javascript">

    $(window).on("load", function() {

      $("tbody tr[evindex='0']").each(function(index) { /* add class c1/c2 even/odd rows */
        if (index % 2 === 0) { 
          $(this).attr('class', 'c1'); /* father */
          pgroup = $(this).attr('group');  /*  children process group identifier */
          $("tr[group='" + pgroup + "']:not([evindex='0'])").attr('class', 'c1');
        }
        else { 
          $(this).attr('class', 'c2'); /* father */
          pgroup = $(this).attr('group');  /*  children process group identifier */
          $("tr[group='" + pgroup + "']:not([evindex='0'])").attr('class', 'c2');
        }
      }); 

      $("tr[evindex='0']:not([evn='1']) td:nth-child(6)").click(function(event) {
        element = $(this).parent();
        if( element != 'INPUT' ){ /* to avoid collapse on click on checkbox */
          $("body").css("cursor", "progress"); /* wait cursor */
          //open up the events - toggle from the process atribute 
          pgroup = element.attr('group');  
          events = $("tr[group='" + pgroup + "']:not([evindex='0'])")                    
          nenv = events.length;
          events.each(function(index, event){         
            /* toogle slide up/down for all event rows except last */
            if(index < nenv-1)
              $(event).slideToggle();             
          });
          /* triggers POST to save on last one on json table */          
          events.last().slideToggle(function(){
            var data = {};
            data['process'] = pgroup;
            data['style'] = $(this).css('display'); 
            fetch("/update_events_view", {
              method: "POST",
              headers: {'Content-Type': 'application/json'}, 
              body: JSON.stringify(data)
            }).then(function(response) {
              $("body").css("cursor", "default"); /* default cursor */
            });     
          }); 
        }        
      });

      $("input[type='checkbox']").click(function(event) {
        $("body").css("cursor", "progress"); /* wait cursor */               
        var data = []; 
        // get state of all checkboxes and update backend for all
        $("input[type='checkbox']").each(function(i, element) {          
          parent = element.parentElement.parentElement.getAttribute('group');          
          data.push([parent, element.checked]); // fill in list/array
        });
        fetch("/update_checkbox", {
          method: "POST",
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(data)
        }).then(function(response) {
          $("body").css("cursor", "default"); /* default cursor */
        });          
      });

      $("tr[evindex='0']:not([evn='1']) td:nth-child(3)").wrap(function() {        
        return "<a href='/process?process="+$(this).text()+"'/></a>";
      });

      $(".copyprocess1, .copyprocess2").click(function(event) {
        event.preventDefault();
        navigator.clipboard.writeText($(this).text());
      })

    });

    {% if processo is defined %}
      document.title = "{{ processo }}"; /* set window name to easy work */
    {% else %}  
      document.title = "Work"; /* set window name to easy work */
    {% endif %} 

    // F5 or refresh page event: changes the cursor
    $(window).on("beforeunload", function() {
      $("*").css("cursor", "progress");      
    });    

  </script>
  <style>
    html {
      font-size: 14px; 
      font-family: Verdana, Geneva, Tahoma, sans-serif;
      background-color: rgb(241, 248, 248);
      }
    table {      
      width: 100%;
      border: 1px solid #CCC;
      border-collapse: collapse;
    }
    th {
      font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
      font-size: 16px;
      border: none;      
    }
    td { /* default settings */   
      border: none;
      text-align: center;      
      max-width: fit-content;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    tr[evindex='0']:not([evn='1']) td:nth-child(4), 
    tr[evindex='0']:not([evn='1']) td:nth-child(5),
    tr[evindex='0']:not([evn='1']) td:nth-child(6),
    tr[evindex='0']:not([evn='1']) td:nth-child(7){ /* has events - mark bold */      
      font-weight: bolder;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;      
    } 
    tbody tr[ativo='não'] { /* mark dead processes */
      color: rgb(148, 13, 40);      
    }
    tbody tr[ativo='sim'] { /* mark dead processes */
      color: blue;      
    }
    /* Descrição (6) must be readable completely */
    tr td:nth-child(6) { max-width: fit-content !important; }
    /* OBS(7) DOU(8) set max-width with rem - 
    don't need to read at first glance */
    tr td:nth-child(11), tr td:nth-child(12) {
      max-width: 15rem !important;
    } 
    /* to read overflow hidden text on 11, 12 */
    tr td:nth-child(11):hover, tr td:nth-child(12):hover { /* disable overflow on hover */
      /* show content as a box */
      overflow: visible;
      white-space: normal;
      position: fixed;
      background-color: white;
      box-shadow: 0 0 4px 0 black;
    }
    tr.c1 { background-color: white;   }
    tr.c2 { background-color: #78b0de;   }
    tr:hover { background-color: rgb(180, 180, 180) !important; }
    /* <!-- https://css-tricks.com/snippets/css/a-guide-to-flexbox/ --> */
    .container {
      display: flex;
      justify-content: center;
      align-items: stretch ;
      list-style: none;
      margin: 0;       
      color : white;
      font-size: medium;   
    }
    .container li {
      background: burlywood;
      text-decoration: none;
      justify-content: baseline;
      display: flex;      
      padding: 0.5em;      
      border: 3px solid white;
    }
  </style>  
</head> 
<body>
  {% if processos_list %}    
    <h2>Pick a process</h2>
    <ol>
    {% for process_, dados_ in processos_list %}  
      <li><a href="/select?selected={{ process_.replace('/','-') }}" target="_blank">{{ process_ }}</a> &#9830; SEI: <a class="copyprocess1" href="/copynup" >{{ dados_['NUP'] }} </a> &#9830; <a href='/process?process={{ process_ }}' target="_blank">SCM</a></li>
      {% endfor %}
    </ol>
    <div style="display:flex;">
      <div style="font-weight: bold;">Working folder:</div>
      <div>{{ work_folder }} </div>
    </div>
  <div style="display:flex;color: cornflowerblue;">
    <div>Press F5 to reload</div>
  </div>    
  <footer>Loaded {{ dbloaded }} processes from database in {{ time_spent }} seconds. </footer>  
  {% else %}    
    <ul class="container">
      <li> <a>Prioridade: {{ dados['prioridade'] }}</a> </li>
      <li> <a href='/process?process={{ processo }}'>SCM</a> </li>
      <li> <a>SEI:</a><a class="copyprocess2" href="/copynup" >{{ dados['NUP'] }} </a> </li>
      <li> <a>1<sup>st</sup> parent: 
        {% if dados['parents'] %}
          {{ dados['parents'][0] }}
        {% else %}
          {{ 'None' }}
        {% endif %}
      </a> </li>
      <li> <a id="iestudo">Done</a> </li>     
    </ul>     
    {{ pandas_table|safe }}     
  {% endif %}    
</body>
</html>





   
